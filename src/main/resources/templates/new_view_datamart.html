<!DOCTYPE html>
<!--
  ~ Copyright Verizon Media, Licensed under the terms of the Apache License, Version 2.0. See LICENSE file in project root for terms.
  -->
<html lang="en">

<head th:replace="fragments/head :: head">
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, shrink-to-fit=no, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Data Mart Onboarding Tool</title>
    <link rel="shortcut icon" href="../static/favicon.ico" type="image/x-icon" />
    <link rel="icon" href="../static/favicon.ico" type="image/x-icon" />
    <!--/* jQuery */-->
    <script src="../static/js/jquery.js"></script>
    <!--/* Bootstrap */-->
    <script src="../static/js/bootstrap.min.js"></script>
    <link href="../static/css/bootstrap.min.css" rel="stylesheet" />
    <!--/* Data table */-->
    <script src="../static/js/jquery.dataTables.min.js"></script>
    <script src="../static/js/dataTables.bootstrap.min.js"></script>
    <link href="../static/css/dataTables.bootstrap.min.css" rel="stylesheet" />
    <!--/* Query Builder, custom POT build */-->
    <script src="../static/js/query-builder.standalone.min.js"></script>
    <link href="../static/css/query-builder.default.min.css" rel="stylesheet" />
    <!--/* Select2 */-->
    <script src="../static/js/select2.min.js"></script>
    <link href="../static/css/select2.min.css" rel="stylesheet" />
    <link href="../static/css/select2-bootstrap.min.css" rel="stylesheet" />
    <!--/* Sidebar CSS */-->
    <link href="../static/css/simple-sidebar.css" rel="stylesheet" />
    <!--/* Switch */-->
    <link href="../static/css/bootstrap-switch.css" rel="stylesheet" />
    <script src="../static/js/bootstrap-switch.min.js"></script>
    <!--/* Toastr for notifications */-->
    <link href="../static/css/toastr.min.css" rel="stylesheet" />
    <script src="../static/js/toastr.min.js"></script>
    <!--/* Funnelmart CSS */-->
    <link href="../static/css/funnelmart.css" rel="stylesheet" />
    <!--/* HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries */-->
    <!--/* WARNING: Respond.js doesn't work if you view the page via file:// */-->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
<div id="wrapper">
    <!-- Sidebar -->
    <div id="sidebar-wrapper" th:replace="fragments/nav :: nav">
        <ul class="sidebar-nav">
            <li class="sidebar-brand">
                <div class="text-center">
                    <img src="../static/img/logo.png" width="150" />
                </div>
                <a href="#">Data Mart Onboarding Tool</a>
            </li>
            <li>
                <a href="#">Help</a>
            </li>
            <li>
                <a href="#">List Data Marts</a>
            </li>
            <li>
                <a href="#">New Data Mart</a>
            </li>
            <div id="version" th:text="${version}">v0.0.0</div>
        </ul>
    </div>
    <!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">
        <div class="container-fluid">
            <div class="row">
                <div class="col-lg-12">
                    <h1 th:text="${viewPipeline != null} ? 'View Data Mart' : 'New Data Mart' ">TITLE</h1>
                    <div th:switch="${error != null}">
                        <!--/* Else, show pipeline info */-->
                        <div th:case="${false}">
                            <!--form id="newDatamartForm" class="form-horizontal" method='post' action="/datamart/new"-->
                            <form id="newDatamartForm" method='post' action="/datamart/new">
                                <fieldset>
                                    <!-- Name of datamart -->
                                    <div class="form-group">
                                        <label class="control-label" for="dataMartName">Name</label>&nbsp;<a id="tooltip-name-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                        <div>
                                            <input id="dataMartName" name="dataMartName" type="text" pattern="[A-Za-z0-9 _-]{1,30}" placeholder="Name of data mart" class="form-control input-md" required="" th:value="${pipelineName != null} ? ${pipelineName}" th:disabled="${viewPipeline != null} ? 'true'"></input>
                                        </div>
                                        <div id="tooltip-name" class="popover" role="tooltip">
                                            <div>
                                                <h5 class="tooltip-header">Name of the Data Mart</h5>
                                                <p>Name of your mart. The name should be unique on Cubed. If you attempt to use a used name, a warning message will show up when you save the mart. This name is also used as your data mart table name.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Description of datamart -->
                                    <div class="form-group">
                                        <label class="control-label" for="dataMartDescription">Description</label>&nbsp;<a id="tooltip-description-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                        <div>
                                            <input id="dataMartDescription" name="dataMartDescription" type="text" pattern="[A-Za-z0-9 _-]{1,60}" placeholder="Description sentence for data mart" class="form-control input-md" required="" th:value="${pipelineDescription != null} ? ${pipelineDescription}"></input>
                                        </div>
                                        <div id="tooltip-description" class="popover" role="tooltip">
                                            <div>
                                                <h5 class="tooltip-header">Description of the Data Mart</h5>
                                                <p>A simple description sentence briefly introduces the purpose of this mart.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Owner of datamart -->
                                    <div class="form-group">
                                        <label class="control-label" for="dataMartOwner">Owner</label>&nbsp;<a id="tooltip-owner-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                        <div>
                                            <input id="dataMartOwner" name="dataMartOwner" type="text" pattern="[A-Za-z0-9 _-]{1,30}" placeholder="Owner of data mart" class="form-control input-md" required="" th:value="${pipelineOwner != null} ? ${pipelineOwner}"></input>
                                        </div>
                                        <div id="tooltip-owner" class="popover" role="tooltip">
                                            <div>
                                                <h5 class="tooltip-header">Owner of the Data Mart</h5>
                                                <p>Usually the creator is the owner of the data mart.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Schema of datamart -->
                                    <div class="form-group">
                                        <label class="control-label" for="schemaSelector">Schema</label>&nbsp;<a id="tooltip-schema-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                        <span id="schemaSelectorGroup">
                                            <select class="form-control" name="schemaSelector" id="schemaSelector" th:disabled="${viewPipeline != null} ? 'true'">
                                                <option th:each="schema : ${schemas}" th:text="${schema}" th:value="${schema}"  th:selected="${defaultSchema==schema}">schema_name</option>
                                            </select>
                                        </span>
                                        <div id="tooltip-schema" class="popover" role="tooltip">
                                            <div>
                                                <h5 class="tooltip-header">Schema the Data Mart is Created On</h5>
                                                <p>The schema of the data source. Different schemas provide different fields to choose from in <b>Project</b> and <b>Filter</b> section. If you change the schema when creating your data mart, the current progress will be lost.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Project columns -->
                                    <div class="form-group">
                                        <label class="control-label" for="dataMartProject">Project</label>&nbsp;<a id="tooltip-project-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                        <div>
                                            <!-- Add a new projection button for dimension and metric-->
                                            <button type="button" class="btn btn-success" data-toggle="modal" onclick="ShowModal(false,'Dimension')">Add Dimension</button>
                                            <button type="button" class="btn btn-success" data-toggle="modal" onclick="ShowModal(false,'Metric')">Add Metric</button>
                                            <div id="tooltip-project" class="popover" role="tooltip">
                                                <div>
                                                    <h5 class="tooltip-header">Adding Projections to Datamart</h5>
                                                    <p><b>Dimensions</b> are descriptive values or characteristics of your data. You can select them directly and they will show up as projections in your data mart. </p>
                                                    <p><b>Metrics</b> are numeric, measurable results. You can choose from <b>SUM</b> and <b>COUNT DISTINCT</b> metrics here.</p>
                                                    <p>Both dimension and metric support aliases. If an alias is set, the column name in the output datamart will be the alias.</p>
                                                </div>
                                            </div>

                                            <!-- Table to display the projections -->
                                            <table id="projectionTable"  class="table table-striped table-hover table-bordered" style="width:100%;border-collapse:collapse">
                                                <thead>
                                                <tr>
                                                    <th>Column</th>
                                                    <th>Alias</th>
                                                    <th>Value Mapping</th>
                                                    <th>Aggregate</th>
                                                    <th>Key</th>
                                                    <th>Column ID</th>
                                                    <th>Aggregate ID</th>
                                                </tr>
                                                <!-- create default row w/ no bottom border to go w/ style of added projections -->
                                                <tr>
                                                    <td style="border-bottom: 0px">COUNT(*)</td>
                                                    <td style="border-bottom: 0px">record_count</td>
                                                    <td style="border-bottom: 0px">Value mapping not supported for Metrics.</td>
                                                    <td style="border-bottom: 0px">COUNT</td>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Filter -->
                                    <div class="form-group">
                                        <label class="control-label" for="filter">Filter</label>&nbsp;<a id="tooltip-filter-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                        <div>
                                            <div id="filterBuilder"></div>
                                        </div>
                                        <div id="tooltip-filter" class="popover" role="tooltip">
                                            <div>
                                                <h5 class="tooltip-header">Filters Against the Source Data</h5>
                                                <p>The filters perform the "slicing" and "dicing" in data mart creation. They determine which records will be part of the output data. Complex combinations of AND and OR filters are supported, as well as arbitrary nesting of groups of filters.</p>
                                                <p>A <b>Filter Group</b> consists of at least one filter. All filters within a Filter Group have either an AND or a OR relationship combine them, determined by the AND or OR toggle at the top left of each group.</p>
                                                <p><b>First level columns</b> can be found in the drop down list on each Filter Rule.</p>
                                                <p><b>Maps</b> can be accessed as: </p>
                                                <ul>
                                                  <li><b>foo</b> for the entire map.</li>
                                                  <li><b>foo[bar]</b> for the specific "bar" subfield inside the "foo" map. This only works for maps where all subfields are known in the schema configuration.</li>
                                                  <li><b>foo[*]</b> for maps where Cubed does not know all possible subfields, so the user needs to enter the desired subfield manually.</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Backfill -->
                                    <div class="form-group">
                                        <label class="control-label" for="backfillEnabled">Start Date</label>&nbsp;<a id="tooltip-start-date-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                        <div id="backfillStartDateSelector">
                                            <div id="backfillStartDateSelectorTextGroup" class="input-group date">
                                                <input type="text" id="backfillStartDateSelectorText" pattern="[A-Za-z0-9 _-]{1,30}" class="form-control"/>
                                                <span class="input-group-addon"><i class="glyphicon glyphicon-th"></i></span>
                                            </div>
                                        </div>
                                        <div id="tooltip-start-date" class="popover" role="tooltip">
                                            <div>
                                                <h5 class="tooltip-header">Start Date of the Data Mart</h5>
                                                <p>The start date determines from which date the data mart backfills.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Bullet preview-->
                                    <div class='form-group'>
                                        <label class="bullet-label" for="bullet" th:if="${!disable_bullet}">Bullet Preview</label>&nbsp;<a id="tooltip-bullet-preview-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign" th:if="${!disable_bullet}"></a><p th:if="${!disable_bullet}"></p>
                                        <!-- filled in through jquery -->
                                        <button type="button" class="btn btn-success" id="previewEtl">Preview Hive SQL</button>
                                        <button type="button" class="btn btn-success" id="queryBullet" th:if="${!disable_bullet}">Submit Bullet Query</button>
                                        <div class="form-group">
                                                    <br />
                                                    <table id="etlPreviewTable" class="table table-striped table-hover table-bordered" style="width:100%;display:none;">
                                                        <tr><td>
                                                    <div id="etlPreview" style="white-space:pre-wrap;"></div>
                                                </td></tr>
                                            </table></div>
                                        <div id="queryBulletResultsDiv" class="hidden form-control" style="height:200px; overflow:auto; white-space:pre-wrap;" th:if="${!disable_bullet}"></div>
                                        <div id="tooltip-bullet-preview" class="popover" role="tooltip" th:if="${!disable_bullet}">
                                            <div>
                                                <h5 class="tooltip-header">Preview of the Data Mart</h5>
                                                <p>The <b>Preview Hive SQL</b> function shows you the Hive query composed by your data mart specification. When the data mart pipeline is launched to production, this Hive query will be run regularly.</p>
                                                <p>By using the <b>Submit Bullet Query</b> function, you can query Bullet to get a sneak peak of the results you could expect to receive when the data mart is deployed.</p>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Show Oozie link -->
                                    <div id="oozieJobLinkStatusGroup" style="display:none">
                                        <div class="form-group">
                                            <label class="control-label" for="oozieJobLink">Oozie Job</label>&nbsp;<a id="tooltip-oozie-job-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                            <div id="oozieJobLinkDiv">
                                                        <span class="form-control input-md" style="
                                                                            font-weight: normal;
                                                                            line-height: 24px;
                                                                            font-size: 14px;
                                                                            display: inline-block;">
                                                            <span class="glyphicon glyphicon-link"></span>
                                                	        <a target="_blank" th:href="${oozieJobLink}" th:text="${oozieJobId}">id</a>
                                                	    </span>
                                            </div>
                                            <div id="tooltip-oozie-job" class="popover" role="tooltip">
                                                <div>
                                                    <h5 class="tooltip-header">Oozie Job URL</h5>
                                                    <p>The go-forward Oozie job URL. This Oozie job is started from the deployment date of this data mart.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Show Oozie backfill job link -->
                                    <div id="oozieBackfillJobLinkStatusGroup" style="display:none">
                                        <div class="form-group">
                                            <label class="control-label" for="oozieBackfillJobLink">Oozie Backfill Job</label>&nbsp;<a id="tooltip-oozie-backfill-job-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                            <div id="oozieBackfillJobLinkDiv">
                                                <span class="form-control input-md" style="
                                                                    font-weight: normal;
                                                                    line-height: 24px;
                                                                    font-size: 14px;
                                                                    display: inline-block;">
                                                    <span class="glyphicon glyphicon-link"></span>
                                        	        <a target="_blank" th:href="${oozieBackfillJobLink}" th:text="${oozieBackfillJobId}">id</a>
                                        	    </span>
                                            </div>
                                            <div id="tooltip-oozie-backfill-job" class="popover" role="tooltip">
                                                <div>
                                                    <h5 class="tooltip-header">Oozie Backfill Job URL</h5>
                                                    <p>The backfill Oozie job URL. This Oozie job is started from the start date specified for this data mart.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Show Pivot and Superset UI links -->
                                    <div id="uiLinkStatusGroup" style="display:none">

                                        <div class="form-group">
                                            <label class="control-label">Visualize this datamart</label>&nbsp;<a id="tooltip-visualize-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a>
                                            <div>
                                                        <span class="form-control input-md" style="font-weight: normal;
                                                                                                    line-height: 24px;
                                                                                                    font-size: 14px;
                                                                                                    display: inline-block;">
                                                            <span class="glyphicon glyphicon-link"></span>
                                                	        <a target="_blank" th:href="${pivotUILink}">Turnilo</a>
                                                	    </span>
                                                <p></p>
                                                <span class="form-control input-md" style="font-weight: normal;
                                                                                                    line-height: 24px;
                                                                                                    font-size: 14px;
                                                                                                    display: inline-block;">
                                                            <span class="glyphicon glyphicon-link" ></span>
                                                	        <a target="_blank" th:href="${supersetUILink}">Superset</a>
                                                	    </span>
                                            </div>
                                            <div id="tooltip-visualize" class="popover" role="tooltip">
                                                <div>
                                                    <h5 class="tooltip-header">Links to Visualization Tools</h5>
                                                    <p>Here lists the BI tools supported by Cubed.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Buttons: Submit, Download, Launch, Delete, etc -->
                                    <div class="form-group">
                                        <label class="control-label" for="submit">Actions</label>&nbsp;<a id="tooltip-actions-icon" href="javascript://" data-toggle="popover" class="glyphicon glyphicon-info-sign"></a><p></p>
                                        <div>
                                            <!-- Buttons when creating pipeline -->
                                            <span th:if="${viewPipeline == null}">
                                                        <button id="submitNewDatamart" name="submit" class="btn btn-success">Save</button>
						                            </span>
                                            <span th:if="${viewPipeline != null}">
                                                        <!-- Pipeline is not in deleted state. -->
                                                        <span th:if="${pipelineDeleted == false}">
                                                            <button type="button" id="launchDatamart" class="btn btn-success" data-toggle="modal" data-target="#launchConfirmModal" th:disabled="${!schemas.contains(defaultSchema)}">Launch To Production</button>
                                                            <button type="button" id="updateDatamart" class="btn btn-success hidden" data-toggle="modal" data-target="#updateConfirmModal" th:disabled="${!schemas.contains(defaultSchema)}">Update</button>
                                                            <button type="button" id="downloadDatamart" class="btn btn-info">Download</button>
                                                            <button type="button" id="cloneDatamart" class="btn btn-info" data-toggle="modal" data-target="#cloneConfirmModal" th:disabled="${!schemas.contains(defaultSchema)}">Clone</button>
                                                            <!-- Only show stop button if pipeline is active (not Inactive). -->
                                                            <span id="activeSpan" th:if="${pipelineStatus != 'Inactive'}">
                                                                <button type="button" id="stopDatamart" class="btn btn-danger" data-toggle="modal" data-target="#stopConfirmModal">Stop</button>
                                                            </span>
                                                            <!-- Only show delete button if status is 'Inactive'. -->
                                                            <span id="inactiveSpan" th:if="${pipelineStatus == 'Inactive'}">
                                                                <button type="button" id="deleteDatamart" class="btn btn-danger" data-toggle="modal" data-target="#deleteConfirmModal">Delete</button>
                                                            </span>
                                                       	</span>
                                                <!-- Pipeline is in deleted state. -->
                                                        <span th:if="${pipelineDeleted == true}">
                                                            <button type="button" id="cloneDatamart" class="btn btn-success" data-toggle="modal" data-target="#cloneConfirmModal" th:disabled="${!schemas.contains(defaultSchema)}">Clone</button>
                                                            <button type="button" id="restoreDatamart" class="btn btn-success" data-toggle="modal" data-target="#restoreConfirmModal" th:disabled="${!schemas.contains(defaultSchema)}">Restore Pipeline</button>
                                                        </span>
                                                    </span>
                                        </div>
                                        <div id="tooltip-actions" class="popover" role="tooltip">
                                            <div>
                                                <h5 class="tooltip-header">Actions Can be Performed</h5>
                                                <p>According to different stages of the data mart pipeline, different subsets of actions can be performed.</p>
                                                <p><b>Save</b>: Save the data mart. It appears when creating a new data mart.</p>
                                                <p><b>Launch To Production</b>: Launch a saved data mart pipeline to production to run regularly.</p>
                                                <p><b>Update</b>: Update the current data mart when changes have been made on a saved data mart.</p>
                                                <p><b>Download</b>: Download the saved data mart pipeline specifications.</p>
                                                <p><b>Clone</b>: Clone the current saved data mart. A replicated new data mart will be created.</p>
                                                <p><b>Stop</b>: Stop the deployed (running) data mart pipeline.</p>
                                                <p><b>Delete</b>: Delete an updeployed or stopped data mart pipeline.</p>
                                                <p><b>Restore</b>: Restore a deleted data mart pipeline.</p>
                                            </div>
                                        </div>
                                    </div>
                                </fieldset>
                            </form>
                        </div>
                        <div th:case="${true}">
                            <label class="control-label">There was a problem parsing the URL. Please specify the schema.</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Launch Confirmation Modal -->
        <div id="launchConfirmModal" th:replace="fragments/launch_confirm_modal :: launchConfirmModal"></div>
        <!-- Stop Confirmation Modal -->
        <div id="stopConfirmModal" th:replace="fragments/stop_confirm_modal :: stopConfirmModal"></div>
        <!-- Delete Confirmation Modal -->
        <div id="deleteConfirmModal" th:replace="fragments/delete_confirm_modal :: deleteConfirmModal"></div>
        <!-- Clone Confirmation Modal -->
        <div id="cloneConfirmModal" th:replace="fragments/clone_confirm_modal :: cloneConfirmModal"></div>
        <!-- Restore Confirmation Modal -->
        <div id="restoreConfirmModal" th:replace="fragments/restore_confirm_modal :: restoreConfirmModal"></div>
        <!-- View Datamart ETL modal -->
        <div id="viewDatamartEtlModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-body">
                        <pre id="viewDatamartEtlModalCode"></pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" data-dismiss="modal" class="btn btn-info">Done</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Update Confirmation Modal -->
        <div id="updateConfirmModal" th:replace="fragments/update_confirm_modal :: updateConfirmModal"></div>
        <!-- Add Value Mapping Modal -->
        <div id="addVMModal" class="modal fade" role="dialog">
            <div class="modal-dialog">
                <!-- Modal content -->
                <div class="modal-content">
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <button type="button" class="close"
                                data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title">
                            Create Value Mapping
                        </h4>
                    </div>
                    <!-- Modal body -->
                    <div class="modal-body">
                        <form id="addVMForm" class="form-horizontal" role="form">
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="vaValue">Value</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="vaValue" pattern="[A-Za-z0-9 _-]{1,30}" required="required" placeholder="Value of the field"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label" for="vaAlias">Alias</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="vaAlias" pattern="[A-Za-z0-9 _-]{1,30}" required="required" placeholder="Alias of the value"/>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="col-sm-offset-2 col-sm-10">
                                    <button id="submit-add-va" type="submit" class="btn btn-success">Add</button>
                                    <button id="cancel-add-va" class="btn btn-danger" data-dismiss='modal' aria-hidden='true'>Cancel</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Column Modal -->
        <div id="addColumnModal" class="modal fade" role="dialog">
            <div id="addColumnModalDialog" class="modal-dialog">
                <!-- Modal content-->
                <div class="modal-content" style="height:90%;overflow: hidden;">
                    <!-- Modal Header -->
                    <div class="modal-header">
                        <button type="button" class="close"
                                data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                            <span class="sr-only">Close</span>
                        </button>
                        <h4 class="modal-title" id="addColumnModalLabel">

                        </h4>
                    </div>
                    <form id="addProjections" class="form-horizontal addColumnForm" role="form" style="height:100%">
                        <!-- Modal body -->
                        <div class="modal-body" style="height:83%;overflow: scroll;">
                            <div class="col-sm-8" style="height:100%;overflow: scroll;">
                                <table  class="table table-striped table-bordered" style="width:100%;border-collapse:collapse;height:100%">
                                    <thead>
                                    <tr>
                                        <th>Column</th>
                                        <th>Alias</th>
                                        <th>Key</th>
                                        <th class="aggregate-form-display-add">Aggregate</th>
                                        <th>Select</th>
                                    </tr>
                                    <!-- create default row w/ no bottom border to go w/ style of added projections -->
                                    </thead>
                                    <tbody>
                                    <tr th:id="|projection-field-${counter.index}|" class="projection-field" th:each="field,counter: ${fields}" th:if="${field.isNotSimpleType()} == false" th:attr="dbId=${field.getFieldId()},value=${field.getFieldNameId()},type=${field.getFieldType()},key=${field.getKey()}" value="1" type="string">
                                        <td style="border-bottom: 0px;vertical-align:middle" th:text="${field.getFieldNameId()}">COUNT(*)</td>
                                        <td style="border-bottom: 0px;vertical-align:middle">
                                            <input type="text" class="form-control" pattern="[a-z_]*" title="Starts with letter, contains lowercase letters and underscores" th:attr="placeholder=${field.getFieldNameId()}"/>
                                        </td>
                                        <td style="border-bottom: 0px;vertical-align:middle">
                                            <div th:if="${field.getKey()} == '*'">
                                                <input type="text" class="form-control" pattern="[A-z0-9_]*" title="Only alphanumeric characters and underscores are allowed" placeholder="Key, only used with map columns"/>
                                            </div>
                                        </td>
                                        <td class="aggregate-form-display-add" style="border-bottom: 0px;vertical-align:middle">
                                            <select class="form-control" style="width:100%">
                                                <option value="THETA_SKETCH" selected="selected">Count Distinct</option>
                                                <option value="SUM">Sum</option>
                                            </select>
                                        </td>
                                        <td style="border-bottom: 0px;vertical-align:middle">
                                            <button type="button"
                                                    class="btn btn-sm projection-field-selector"
                                                    style="background-color:#82CDFF; color:white; outline:none"
                                                    th:onclick="|addProjection(${counter.index})|"
                                                    th:id="|projection-field-selector-${counter.index}|"><i class="glyphicon glyphicon-chevron-right"></i></button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-sm-4" style="height:100%;">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h3 class="panel-title">Selected</h3>
                                    </div>
                                    <div class="panel-body" >
                                        <ul id="selected-projection-field-group" style="padding:0">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Modal Footer -->
                        <div class="modal-footer">
                            <div class="col-sm-3" style="padding-left:0px">
                                <div id="projection-field-search-container">
                                    <!--<label class="control-label" for="projectionFieldSearch">Search</label>-->
                                    <input type="text" class="form-control va-input" id="projection-field-search" pattern="[A-Za-z0-9 _-]{1,30}" onkeyup="projectionFieldSearch()" placeholder="Search for columns"/>
                                </div>
                            </div>
                            <div class="col-sm-9">
                                <button type="submit" class="btn btn-success">Confirm Add Selected</button>
                                <button class="btn btn-danger" data-dismiss='modal' aria-hidden='true'>Cancel</button>
                            </div>
                        </div>
                    </form>
                    <form id="editProjections" class="form-horizontal addColumnForm" role="form" style="height:100%">
                        <!-- Modal body -->
                        <div class="modal-body" style="height:83%;overflow: scroll;">
                            <div>
                                <div class="form-group" id="aggregate-form-display">
                                    <label class="col-sm-2 control-label" for="columnAggregate">Aggregate</label>
                                    <div class="col-sm-10">
                                        <select class="form-control" id="aggregate-selector" style="width:100%">
                                            <option value="THETA_SKETCH" selected="selected">Count Distinct</option>
                                            <option value="SUM">Sum</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label" for="columnToAdd">Column</label>
                                    <div class="col-sm-10">
                                        <select class="form-control width-all" id="column-selector" style="width:100%">
                                            <option th:each="field,counter: ${fields}" th:attr="dbId=${field.getFieldId()},value=${field.getFieldNameId()},type=${field.getFieldType()},key=${field.getKey()}" th:text="${field.getFieldNameId()}" th:if="${field.isNotSimpleType()} == false" value="1" type="string">column_1</option>
                                            <!--<th:block th:if="${false}">-->
                                            <!--<option value="2" type="map">column_2_map</option>-->
                                            <!--<option value="3" type="string">column_3</option>-->
                                            <!--<option value="4" type="string">column_4</option>-->
                                            <!--<option value="5" type="map">column_5_map</option>-->
                                            <!--</th:block>-->
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group" id="mapKeyGroup">
                                    <label class="col-sm-2 control-label" id="columnKeyToAddLabel" for="mapKey">Key</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="columnKeyToAdd" pattern="[A-z0-9_]*" title="Only alphanumeric characters and underscores are allowed" required="required" placeholder="Key, only used with map columns"/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="col-sm-2 control-label" for="columnAlias">Alias</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="columnAlias" pattern="[a-z_]*" title="Starts with letter, contains lowercase letters and underscores" required="required" placeholder="Alias for column"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Modal Footer -->
                        <div class="modal-footer">
                            <div class="col-sm-offset-2 col-sm-10">
                                <button type="submit" class="btn btn-success">Add</button>
                                <button class="btn btn-danger" data-dismiss='modal' aria-hidden='true'>Cancel</button>
                                <button id="delete-add-column" class="btn btn-warning" data-dismiss='modal' aria-hidden='true'>Delete</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!--/* Select Datamart Schema Modal */-->
        <div id="selectDatamartSchemaModal" th:replace="fragments/select_datamart_schema_modal :: selectDatamartSchemaModal"/>
        <!--/* Select Funnel Schema Modal */-->
        <div id="selectFunnelSchemaModal" th:replace="fragments/select_funnel_schema_modal :: selectFunnelSchemaModal"/>
    </div>
    <!-- /#page-content-wrapper -->
</div>
<!-- /#wrapper -->
<script language="javascript" type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    // If content for the pipeline is modified, limit the actions that can be performed
    // Only perform these actions if viewing pipeline.
    function UpdatePipelineAndLimitActions() {
        /*[+
        // Hide launch, download, and delete button.
        // Show update button.
        if ([[${viewPipeline != null}]]) {
            $('#launchDatamart').addClass('hidden');
            $('#downloadDatamart').addClass('hidden');
            $('#viewDatamartEtl').addClass('hidden');
            $('#deleteDatamart').addClass('hidden');
            $('#updateDatamart').removeClass('hidden');
        }
        +]*/
    }

    $("#tooltip-name-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-name").html();
        },
        placement: "right"
    });

    $("#tooltip-description-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-description").html();
        },
        placement: "right"
    });

    $("#tooltip-owner-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-owner").html();
        },
        placement: "right"
    });

    $("#tooltip-schema-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-schema").html();
        },
        placement: "right"
    });

    $("#tooltip-project-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-project").html();
        },
        placement: "right"
    });

    $("#tooltip-filter-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-filter").html();
        },
        placement: "right"
    });

    $("#tooltip-start-date-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-start-date").html();
        },
        placement: "right"
    });

    $("#tooltip-bullet-preview-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-bullet-preview").html();
        },
        placement: "right"
    });

    $("#tooltip-oozie-job-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-oozie-job").html();
        },
        placement: "right"
    });

    $("#tooltip-oozie-backfill-job-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-oozie-backfill-job").html();
        },
        placement: "right"
    });

    $("#tooltip-visualize-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-visualize").html();
        },
        placement: "right"
    });

    $("#tooltip-actions-icon").popover({
        html: true,
        content: function() {
            return $("#tooltip-actions").html();
        },
        placement: "right"
    });

    /*[+
    if ([[${viewPipeline != null}]] && ![[${schemas}]].includes([[${defaultSchema}]])) {
        $('#schemaSelector')[0].selectedIndex = -1;
    }
    +]*/

    // Hide and initialize backfill date selector
    $('#backfillStartDateSelectorTextGroup').datepicker({
        // past days
        endDate: '-1d',
        format: 'yyyy-mm-dd'
    });
    // Hide and initialize end time date selector
    $('#endTimeDateSelectorTextGroup').datepicker({
        // future days
        startDate: '+1d',
        format: 'yyyy-mm-dd'
    });
    // On edit of description input, require update and disable launch.
    $('#dataMartDescription').on('input', function() {
        UpdatePipelineAndLimitActions();
    });
    // On edit of backfill date selector, require update and disable launch.
    $('#backfillStartDateSelectorText').change(function() {
        UpdatePipelineAndLimitActions();
    });
    // On edit of end time date selector, require update and disable launch.
    $('#endTimeDateSelectorText').change(function() {
        UpdatePipelineAndLimitActions();
    });
    // On edit of data mart owner, require update and disable launch.
    $('#dataMartOwner').on('input', function() {
        UpdatePipelineAndLimitActions();
    });
    // Init the column selector for the column add modal
    var columnProjectionSelector = $("#column-selector").select2({
        placeholder: "Select column to project",
        theme: "bootstrap"
    });
    // Add/remove the projection key based on the selected type
    function manageProjectionKeyBasedOnType() {
        // Get key of column
        var key = $('#column-selector option:selected').attr('key');
        // Check if a generic key
        if (key) {
            if (key === '*') {
                // Show the key input and enable
                $("#mapKeyGroup").show();
                $('#columnKeyToAdd').attr('required', true);
                $('#columnKeyToAdd').val('');
            } else {
                // Hide the key input and set value
                $("#mapKeyGroup").hide();
                $('#columnKeyToAdd').removeAttr('required');
                $('#columnKeyToAdd').val(key);
            }
        } else {
            // Hide the key input and disable
            $("#mapKeyGroup").hide();
            $('#columnKeyToAdd').removeAttr('required');
            $('#columnKeyToAdd').val('');
        }
    }

    var isEditProjection = false;
    function ShowModal(isEdit, typeOfProj) {
        UpdatePipelineAndLimitActions();
        isEditProjection = isEdit;
        // if dimension, hide aggregate attribute
        if (typeOfProj == 'Dimension') {
            $('#aggregate-form-display').hide();
            $('.aggregate-form-display-add').hide();
        }
        // if metric, show aggregate
        if (typeOfProj == 'Metric') {
            $('#aggregate-form-display').show();
            $('.aggregate-form-display-add').show();
        }
        if(isEditProjection) {
            $("#addProjections").hide();
            $("#editProjections").show();
            $("#addColumnModalDialog").removeClass("modal-lg");
        } else {
            $("#addProjections").show();
            $("#editProjections").hide();
            $("#addColumnModalDialog").addClass("modal-lg");
        }
        $('#addColumnModalLabel').text(typeOfProj);
        $('#addColumnModal').modal('show');
    }
    // Decide if we should hide the map key group and disable by default
    manageProjectionKeyBasedOnType();
    // When selecting maps, manage the key field
    columnProjectionSelector.on("select2:select", function (e) {
        manageProjectionKeyBasedOnType();
    });
    // Init the aggregate selector for the column add modal
    $("#aggregate-selector").select2({
        placeholder: "Select aggregate to use",
        theme: "bootstrap"
    });
    // Setup the projection table
    var projectionTable = $('#projectionTable').DataTable({
        "language": {
            "emptyTable": "No columns projected."
        },
        "paging": false,
        "ordering": false,
        "info": false,
        "searching": false,
        // Hide the column id and the aggregate id
        "columnDefs": [{
            "targets": [-1, -2, -3],
            "visible": false,
            "searchable": false
        },
            {
                "targets": [2],
                "render": function(data, type, row, meta) {
                    var result = '';
                    if ((row[8] && row[8] === "Dimension") || row[3] === "None" || !row[3]) {
                        if (data && data.length > 0 ) {
                            result += '<ul class="va-list" style="list-style:none;padding:0">\n';
                            for (var i = 0; i < data.length; i++) {
                                result +=
                                    '<li style="margin-top:10px">\n' +
                                    '<div>\n' +
                                    '<input type="text" class="form-control va-input" pattern="[A-z- ]{1,30}" value="'+ data[i][0] + '" id="val-' + meta.row + '-' + i + '"/>\n' +
                                    '<i class="glyphicon glyphicon-arrow-right"></i>\n' +
                                    '<input type="text" class="form-control va-input" pattern="[A-z- ]{1,30}" value="'+ data[i][1] + '" id="ali-' + meta.row + '-' + i + '"/>\n' +
                                    '<button type="button" class="btn btn-xs btn-danger" onclick="removeVM(event,' + meta.row + ',' + i +')">\n' +
                                    '<i class="glyphicon glyphicon-remove"></i>\n' +
                                    '</button>\n' +
                                    '</div>\n' +
                                    '</li>';
                            }
                            result += '<button class="btn btn-success" type="button" style="margin-top:10px" onclick="ShowVMModal(event,' + meta.row + ')">Add</button>';
                        } else {
                            result += '<button class="btn btn-success" type="button" onclick="ShowVMModal(event,' + meta.row + ')">Add</button>';
                        }
                    } else {
                        row[2] = null;
                        result = "Value mapping not supported for Metrics."
                    }

                    return result;
                }
            }]
    });

    function ShowVMModal(e, row) {
        e.stopImmediatePropagation();
        rowIndexToModify = row;
        $("#vaValue").val('');
        $("#vaAlias").val('');
        $("#addVMModal").modal('show');
    }

    function removeVM(e, row, i) {
        UpdatePipelineAndLimitActions();
        e.stopImmediatePropagation();

        var rowContent = projectionTable.row(row).data();
        rowContent[2].splice(i, 1);
        projectionTable.row(row).data(rowContent);

    }

    function projectionFieldSearch(){
        console.log("triggered");
        var input = $("#projection-field-search").val();
        var tr = $("tr.projection-field");
        for (var i = 0; i < tr.length; i++) {
            if ($(tr[i].getElementsByTagName('td')[1]).html().indexOf(input) != -1) {
                $(tr[i]).css("display", "");
            } else {
                $(tr[i]).css("display", "none");
            }
        }
    }

    var projectionsToAdd = [];
    function guid() {
        function s4() {
            return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
        }
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
    }

    function addProjection(nameid) {
        var fieldId = "#projection-field-"+nameid;
        var addedFieldId = guid();
        var field = $(fieldId);

        field.children().eq(2).find("input.form-control").attr("required", "required");
        if ($("#addProjections")[0].reportValidity()) {
            var mapKey = field.children().eq(2).find("input").val();
            var columnName = field.children().eq(0).text();
            if (mapKey) {
                columnName = columnName.replace('*', mapKey);
            }
            var aliasName = field.children().eq(1).find("input").val() === "" ? columnName.replace("[", "_").replace("]", "") : field.children().eq(1).find("input").val();
            var type = $('#addColumnModalLabel').text();

            projectionsToAdd.push([
                field.val(),
                field.attr('dbId'),
                columnName,
                field.children().eq(3).find(":selected").val(),
                field.children().eq(3).find(":selected").text(),
                aliasName,
                mapKey,
                addedFieldId
            ]);

            if (type == 'Dimension') {
                $("#selected-projection-field-group").append('<div class="list-group-item list-group-item-action flex-column align-items-start active" style="background-color:#6c00db;border-color:rgb(221, 221, 221);border-radius:0" id="'+addedFieldId.replace('#', '')+'">\n' +
                    '    <div class="d-flex w-100" style="display:inline-block;width:95%">\n' +
                    '      <h5 class="mb-1" style="margin:0; display: inline-block">'+columnName+'</h5>\n' +
                    '      <small>Alias: '+ (aliasName) + '</small>\n' +
                    '      <div style="display:inline-block;float:right" onclick="removeProjection(\'' + addedFieldId + '\')">' +
                    '       <i class="glyphicon glyphicon-remove"></i>' +
                    '      </div>' +
                    '    </div>'+
                    '</div>');
            } else {
                field.children().eq(2).find("input.form-control").attr("required", "required");
                $("#selected-projection-field-group").append('<div class="list-group-item list-group-item-action flex-column align-items-start active" style="background-color:#6c00db;border-color:rgb(221, 221, 221);border-radius:0" id="'+addedFieldId+'">\n' +
                    '    <div class="d-flex w-100" style="display:inline-block;width:95%">\n' +
                    '      <h5 class="mb-1" style="margin:0; display: inline-block">'+columnName+'</h5>\n' +
                    '      <small>Alias: '+ (aliasName) + '</small>\n' +
                    '      <small>Metric: '+ (field.children().eq(3).find(":selected").text()) + '</small>\n' +
                    '      <div style="display:inline-block;float:right" onclick="removeProjection(\'' + addedFieldId + '\')">' +
                    '       <i class="glyphicon glyphicon-remove"></i>' +
                    '      </div>' +
                    '    </div>'+
                    '</div>');
            }
        } else {
            setTimeout(function() {
                field.children().eq(2).find("input.form-control").removeAttr("required");
            }, 1000);
        }
    }

    function removeProjection(addedFieldId) {
        projectionsToAdd = projectionsToAdd.filter(function(p) { return p.length == 8 && p[7] != addedFieldId;});
        $('#'+addedFieldId).remove();
    }

    // Used if modifying row
    var rowToModify = null;
    var rowIndexToModify = -1;
    // Reset the add column modal
    $('#addColumnModal').on('hidden.bs.modal', function(){
        $(this).find('form')[0].reset();
        $('#column-selector').select2();
        $('#aggregate-selector').select2();
        projectionsToAdd = [];
        $("#selected-projection-field-group").empty();
        // Clean up search filter
        $("#projection-field-search").val("");
        var tr = $("tr.projection-field");
        for (var i = 0; i < tr.length; i++) {
            $(tr[i]).css("display", "");
            $(tr[i]).children().eq(2).find("input.form-control").removeAttr("required");
        }
        // Hide/disable the key field if necessary
        manageProjectionKeyBasedOnType();
        // Hide the delete button because we are done modifying
        $('#delete-add-column').hide();
        // Null out the row to modify
        rowToModify = null;
    });
    // Shows an error message box with given message
    function showErrorMessage(msg) {
        toastr.error(msg);
    }
    // Shows an info message box with given message
    function showInfoMessage(msg) {
        toastr.info(msg);
    }
    // Shows a warning message box with given message
    function showWarningMessage(msg) {
        toastr.warning(msg);
    }
    // Return ajax message
    function ajaxMessage(jqXHR, exception) {
        // Show the error message
        if (jqXHR.status === 0) {
            showErrorMessage('Not connected. Verify network connection.');
        } else if (jqXHR.status == 404) {
            showErrorMessage('Requested page not found. [404]');
        } else if (exception === 'parsererror') {
            showErrorMessage('Requested JSON parse failed.');
        } else if (exception === 'timeout') {
            showErrorMessage('Time out error.');
        } else if (exception === 'abort') {
            showErrorMessage('Ajax request aborted.');
        } else {
            showErrorMessage(jqXHR.responseText);
        }
    }
    // given instructions in form of js button, toggle UI buttons
    function toggleButtons(instructions) {
        // iterate through key,val pairs
        $.each(instructions, function(button,action) {
            if (action == 'show') {
                $(button).removeClass('hidden');
            }
            else if (action == 'hide') {
                $(button).addClass('hidden');
            }
        });
    }

    function validateFilter() {
        if(!$('#filterBuilder').queryBuilder('validate')) {
            showErrorMessage("Invalid filter definition.");
            return false;
        }

        filters = $('#filterBuilder').queryBuilder('getRules');
        if (!filters || !filters.rules || filters.rules.length == 0) {
            showErrorMessage("Filter should not be empty.");
            return false;
        }

        return true;
    }

    function buildData(isUpdate) {
        // Build data to send to server
        var data = {};
        // Replace spaces with underscores in data mart name
        if (!isUpdate) {
            data.name = $('#dataMartName').val().trim().replace(/ /g, "_");
        }
        data.schemaName = $('#schemaSelector :selected').select2().val();
        data.description = $('#dataMartDescription').val().trim();
        data.owner = $('#dataMartOwner').val().trim();
        // Used for storing projections
        data.projections = [];
        data.projectionVMs = [];
        // Add every projection
        projectionTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
            var row = this.data();
            // Data in this format: Column[0], Alias[1], Value Mapping[2], Aggregate[3], Key[4], Column ID[5], Aggregate ID[6]
            // Will return: [Column ID, Key, Alias, Aggregate ID]
            // Format is ',' seperate for fields, ':' seperated for projections

            var columnKeyName = null;
            if (row[4]) {
                columnKeyName = row[4];
            } else if (row[0] && row[0].indexOf("[") > -1) { // when adding new enumerated map
                columnKeyName = row[0].substring(row[0].indexOf("[") + 1, row[0].length - 1);
            }

            data.projections.push({
                "column_id": row[5],
                "key": columnKeyName,
                "alias": row[1],
                "aggregate": row[6],
                "schema_name": data.schemaName
            });

            if (row[2]) {
                data.projectionVMs.push(row[2]);
            } else {
                data.projectionVMs.push(null);
            }
        });
        // Add filters
        data.filter = $('#filterBuilder').queryBuilder('getRules');
        if (data.filter.rules.length == 0) {
            data.filter = undefined;
        }
        // Backfill support
        data.backfillEnabled = true;
        data.backfillStartDate = $('#backfillStartDateSelectorText').val();
        // End time
        data.endTimeEnabled = false;
        data.endTimeDate = null;
        return data;
    }
    // JSON obj holding records from bullet query
    var bulletJson;

    // Request Bullet query results
    $("#queryBullet").click(function(e){
        // Stop form from submitting normally
        e.preventDefault();
        showInfoMessage("Submitting query to Bullet");
        if (validateFilter()) {
            // Build data to send to server
            var data = buildData(false);
            var queryIdxInUrl = $(location).attr('href').indexOf("\?");
            var bulletUrl = $(location).attr('href') + "/bullet";
            if (queryIdxInUrl !== -1) {
                bulletUrl = $(location).attr('href').substring(0, queryIdxInUrl) + "/bullet";
            }
            $.ajax({
                // Using POST
                type: 'PUT',
                // Send to bullet URL
                url: bulletUrl,
                // Data object to send
                data: JSON.stringify(data),
                // Recieve text
                dataType: 'text',
                beforeSend: function() {
                    toggleInput(true);
                },
                // Show success message
                success: function(response) {
                    // If json returned, go to parse it
                    if (response.includes('records')) {
                        showInfoMessage("Successfully queried bullet");
                        toggleButtons({'#queryBullet':'hide', '#queryBulletResultsDiv':'show'})
                        bulletJson = JSON.parse(response);
                        if (bulletJson.records.length == 0 ) {
                            $("#queryBulletResultsDiv").text("Bullet query returned no results.");
                        } else {
                            $("#queryBulletResultsDiv").text(JSON.stringify(bulletJson.records, null, 4));
                        }
                    }
                    else if (response == '') {
                        showInfoMessage("No results found");
                    } else {
                        // Else there was a warning, must re-submit bullet query
                        showWarningMessage(response);
                    }
                    toggleInput(false);
                },
                error: function(jqXHR, exception) {
                    ajaxMessage(jqXHR, exception);
                    toggleInput(false);
                }
            });
        }
    });
    // Launch data mart
    $("#launchDatamartModalYes").click(function(){
        showInfoMessage("Launching pipeline, this will take 20 seconds");
        $.ajax({
            // Using POST
            type: 'POST',
            // Send to launch URL
            url: $(location).attr('href') + "/launch",
            // Sent no data
            data: {},
            // Sending JSON
            contentType: "application/json",
            // Recieve text
            dataType: 'text',
            beforeSend: function() {
                toggleInput(true);
            },
            // Show success message
            success: function(response) {
                // If empty reponse, all good
                if (response === "") {
                    showInfoMessage("Launched pipeline");
                    toggleButtons({'#deleteDatamart':'hide'});
                } else {
                    // Else there was a warning, but not a failure
                    showWarningMessage(response);
                }
                // refresh oozie job link, and show Stop button
                $('#oozieJobLinkDiv').load(' #oozieJobLinkDiv');
                $('#oozieBackfillJobLinkDiv').load(' #oozieBackfillJobLinkDiv');
                $('#oozieJobLinkStatusGroup').show();
                $('#oozieBackfillJobLinkStatusGroup').show();
                // if stop button is not already shown, then show (if re-launching an already launched datamart)
                if ($('#stopDatamart').length == 0) {
                    $('#inactiveSpan').append('<div id="stopDatamart" class="btn btn-danger" data-toggle="modal" data-target="#stopConfirmModal">Stop</div>');
                }
                toggleInput(false);
            },
            error: function(jqXHR, exception) {
                ajaxMessage(jqXHR, exception);
                toggleInput(false);
            }
        });
    });
    // Clone data mart
    $("#cloneDatamartModalYes").click(function(){
        window.location = $(location).attr('href').replace('datamart', 'datamart/clone');
    });
    function toggleInput(shouldBeDisabled) {
        $("#newDatamartForm :input").prop("disabled", shouldBeDisabled);
        $("#launchDatamart").prop("disabled", shouldBeDisabled);
    }
    // Stop data mart
    $("#stopDatamartModalYes").click(function(){
        $.ajax({
            // Using PUT
            type: 'PUT',
            // Send to launch URL
            url: $(location).attr('href') + "/stop",
            // Show success message
            success: function(response) {
                showInfoMessage("Stopped pipeline");
                // when stopping, remove stop button and show delete button
                toggleButtons({'#stopDatamart':'hide', '#deleteDatamart':'show'});
                $('#activeSpan').append('<div id="deleteDatamart" class="btn btn-danger" data-toggle="modal" data-target="#deleteConfirmModal">Delete</div>');
            },
            error: ajaxMessage,
            timeout: 15000
        });
    });
    $("#resetDatamartModalYes").click(function(){
        $.ajax({
            // Using PUT
            type: 'PUT',
            // Send to launch URL
            url: $(location).attr('href') + "/reset",
            // Refresh page on success
            success: function(response) {
                showInfoMessage("Reset pipeline");
                setTimeout(function(){
                    window.location.reload(1);
                }, 2000);
            },
            error: ajaxMessage
        });
    });
    $("#restoreDatamartModalYes").click(function(){
        $.ajax({
            // Using PUT
            type: 'PUT',
            // Send to launch URL
            url: $(location).attr('href') + "/restore",
            // Refresh page on success
            success: function(response) {
                showInfoMessage("Restored pipeline");
                setTimeout(function(){
                    window.location.reload(1);
                }, 2000);
            },
            error: ajaxMessage
        });
    });
    // Delete data mart
    $("#deleteDatamartModalYes").click(function(){
        $.ajax({
            // Using POST
            type: 'DELETE',
            // Send to launch URL
            url: $(location).attr('href'),
            // Redirect to main page on delete
            success: function(response) {
                window.location.href = "/cubed";
            },
            error: ajaxMessage
        });
    });
    // Update data mart
    $("#updateDatamartModalYes").click(function(e){
        // Stop form from submitting normally
        e.preventDefault();
        if (validateFilter()) {
            // Build data to send to server
            var data = buildData(true);
            $.ajax({
                // Using PUT
                type: 'PUT',
                // Send to launch URL
                url: $(location).attr('href') + "/update",
                // Data object to send
                data: JSON.stringify(data),
                // Sending JSON
                contentType: "application/json",
                // Receive JSON
                dataType: 'json',
                // Refresh the page on success
                success: function (response) {
                    showInfoMessage("Updated pipeline");
                    var buttonChanges = {'#updateDatamart':'hide','#launchDatamart':'show','#downloadDatamart':'show','#cloneDatamart':'show','#queryBullet':'show','#viewQueryBullet':'hide'};
                    // if it has been previously launched, show stop, else show delete
                    if ($('#stopDatamart').length != 0) {
                        buttonChanges['#stopDatamart'] = 'show';
                        buttonChanges['#deleteDatamart'] = 'hide';
                    } else {
                        buttonChanges['#stopDatamart'] = 'hide';
                        buttonChanges['#deleteDatamart'] = 'show';
                    }
                    toggleButtons(buttonChanges);
                },
                error: ajaxMessage
            });
        }
    });
    // Download data mart
    $("#downloadDatamart").click(function(){
        showInfoMessage("Download datamart");
        window.open($(location).attr('href') + "/download", '_self', '');
    });

    // Preview data mart etl code
    $("#previewEtl").click(function(e){
        // Stop form from submitting normally
        e.preventDefault();
        if (validateFilter()) {
            // Build data to send to server
            var data = buildData(false);
            if (data != null) {
                $.ajax({
                    // Using POST
                    type: 'POST',
                    // URL to send to
                    url: "/datamart/preview",
                    // Data object to send
                    data: JSON.stringify(data),
                    // Sending JSON
                    contentType: "application/json",
                    // Receive text
                    dataType: 'text',
                    // Show the ETL code
                    beforeSend: function() {
                        $("#queryPreviewTable").hide();
                    },
                    success: function (response) {
                        // If the response is same as what we currently have, then assume the user intends to collapse
                        if (typeof document.getElementById("etlPreview").getElementsByTagName('p')[0] != "undefined" && response == document.getElementById("etlPreview").getElementsByTagName('p')[0].innerText) {
                            $("#etlPreviewTable").hide();
                            $("#etlPreview").html("");
                        } else {
                            $("#etlPreview").html("<p>" + response + "</p>");
                            $("#etlPreviewTable").show();
                        }
                    },
                    error: function(jqXHR, exception) {
                        ajaxMessage(jqXHR, exception);
                    }
            });
            }
        }
    });

    // View data mart etl code
    $("#viewDatamartEtl").click(function(){
        // Send the form
        $.ajax({
            // Using POST
            type: 'GET',
            // URL to send to
            url: window.location.href + "/view-etl",
            // Recieve text
            dataType: 'text',
            // Show the ETL code
            success: function (response) {
                $('#viewDatamartEtlModalCode').html(response);
                $('#viewDatamartEtlModal').modal('show');
            },
            error: ajaxMessage
        });
    });
    // Submit the new data mart
    $("#newDatamartForm").submit(function(e) {
        // Stop form from submitting normally
        e.preventDefault();
        if (validateFilter()) {
            // Build data to send to server
            var data = buildData(false);
            // Send the form
            $.ajax({
                // Using POST
                type: 'POST',
                // URL to send to
                url: $(this).attr('action'),
                // Data object to send
                data: JSON.stringify(data),
                // Sending JSON
                contentType: "application/json",
                // Recieve JSON
                dataType: 'json',
                // Redirect to the new pipeline on success
                success: function (response) {
                    window.location.href = "/datamart/" + response
                },
                error: ajaxMessage
            });
        }
    });
    // Submit add column projection form
    $(".addColumnForm").on('submit',function(e){
        // Prevent submit action
        e.preventDefault();
        var valueAlias = [];
        // type refers to dimension or metric, determined from modal header
        var type = $('#addColumnModalLabel').text();

        if (isEditProjection) {
            // Get the column projection values
            var uiColumnId = $('#column-selector :selected').select2().val();
            var columnId = $('#column-selector :selected').select2().attr('dbId');
            var columnName = $('#column-selector :selected').select2().text();
            var aggregateId = $('#aggregate-selector').select2().val();
            var aggregateName = $('#aggregate-selector :selected').select2().text();
            var columnAlias = $('#columnAlias').val();
            var mapKey = $('#columnKeyToAdd').val();

            // if dimension, aggregate is ALWAYS NONE
            if (type == 'Dimension') {
                aggregateName = "None"
                aggregateId = "NONE"
            }
            // If map key is not empty, add key to column displayed to user
            if (mapKey) {
                columnName = columnName.replace('*', mapKey);
            }

            if (rowToModify != null) {
                // Modify the projection
                projectionTable.row(rowToModify).data([columnName, columnAlias, valueAlias, aggregateName, mapKey, columnId, aggregateId, uiColumnId,type]).draw(false);
                // Null out the row to modify
                rowToModify = null;
            }
        } else {
            var projections = projectionsToAdd.filter(function(p) { return p.length === 8; });
            for (var i = 0; i < projections.length; i++) {
                // Get the column projection values
                var uiColumnId = projections[i][0];
                var columnId = projections[i][1];
                var columnName = projections[i][2];
                var aggregateId = projections[i][3];
                var aggregateName = projections[i][4];
                var columnAlias = projections[i][5];
                var mapKey = projections[i][6] == null ? "" : projections[i][6];

                // if dimension, aggregate is ALWAYS NONE
                if (type == 'Dimension') {
                    aggregateName = "None"
                    aggregateId = "NONE"
                }
                // If map key is not empty, add key to column displayed to user
                if (mapKey) {
                    columnName = columnName.replace('*', mapKey);
                }
                // Add the projection
                projectionTable.row.add([columnName, columnAlias, valueAlias, aggregateName, mapKey, columnId, aggregateId, uiColumnId,type]).draw(false);
            }
            projectionsToAdd = [];
            $("#selected-projection-field-group").empty();
        }


        // Hide the delete button because we are done modifying
        $('#delete-add-column').hide();
        // Close modal
        $('#addColumnModal').modal('toggle');
        toggleButtons({'#stopDatamart':'hide'});
        return true;
    });
    // Submit add value mapping
    $("#addVMModal").on('submit',function(e){
        // Prevent submit action
        e.preventDefault();

        var vaValue = $('#vaValue').val();
        var vaAlias = $('#vaAlias').val();
        if (rowIndexToModify !== -1) {
            var rowContent = projectionTable.row(rowIndexToModify).data();
            rowContent[2].push([vaValue, vaAlias]);
            projectionTable.row(rowIndexToModify).data(rowContent);
        }
        // Close modal
        rowIndexToModify = -1;
        $('#addVMModal').modal('toggle');
        UpdatePipelineAndLimitActions();
        // Prevent Immediate Propagation of the click event
        $("input.form-control").click(function(e) {
            e.stopImmediatePropagation();
        });
        return true;
    });
    // Delete button was clicked, remove the projection
    $("#delete-add-column").click(function(){
        // Delete the row
        projectionTable.row(rowToModify).remove().draw(false);
        // Force projectionTable rerender the table
        // so that value mapping input can have correct row index
        projectionTable.rows().invalidate().draw(false);
        // Null out the row to modify
        rowToModify = null;
    });
    // Allow editing of projection tables values
    $('#projectionTable tbody').on('click', 'tr', function () {
        UpdatePipelineAndLimitActions();
        // Check if the table is empty
        if (projectionTable.data().count() == 0) {
            return;
        }
        // Store the row to modify
        rowToModify = this;
        // Get all the settings for the current row and update the modal
        var data = projectionTable.row(rowToModify).data();
        // Get the field
        var fieldMap = JSON.parse(localStorage.getItem("field_map"));
        var fieldKeyObj = fieldMap[data[0]];
        if (!fieldKeyObj) {
            var compositeKey = data[0].replace(data[4], "*");
            fieldKeyObj = fieldMap[compositeKey];
        }
        // Set the column selector and update the key if necessary
        $("#column-selector").val(fieldKeyObj.id).trigger("change");
        manageProjectionKeyBasedOnType();
        // Set the aggregate
        $("#aggregate-selector").val(data[6]).trigger("change");
        // Set alias and key
        $('#columnAlias').val(data[1]);
        $('#columnKeyToAdd').val(data[4]);
        // Show the delete button as an option
        $('#delete-add-column').show();
        // look at aggregate to determine what type of projection
        if (data[3] && data[3] != 'None') {
            data[8] = 'Metric'
        }
        else {
            data[8] = 'Dimension'
        }
        // pop up modal for editing, with apporpriate header (metric or dimension)
        ShowModal(true,data[8])
    });
    // If in view mode, show projections
    /*[+
     var projections = [[${projections}]];
     if (projections != null) {
     for (i = 0; i < projections.length; i++) {
     var columnName = projections[i].fieldNameId;
     var columnAlias = projections[i].alias;
     var aggregateName = projections[i].aggregationName;
     var mapKey = projections[i].key;
     var columnId = projections[i].field.fieldId;
     var aggregateId = projections[i].aggregationName;
     var valueAlias = projections[i].projectionVMs.map(function(d) {
        return [d.fieldValue, d.fieldValueMapping];
     });
     // Map to readable name
     switch (aggregateName) {
     case "NONE":
     aggregateName = "None";
     break;
     case "SUM":
     aggregateName = "Sum";
     break;
     case "MIN":
     aggregateName = "Minimum";
     break;
     case "MAX":
     aggregateName = "Maximum";
     break;
     case "COUNT":
     aggregateName = "Count";
     break;
     case "COUNT_DISTINCT":
     aggregateName = "Count Distinct";
     break;
     case "THETA_SKETCH":
     aggregateName = "Count Distinct";
     break;
     default:
     aggregateName = null;
     break;
     }
     // Add projection to table
     projectionTable.row.add([columnName, columnAlias, valueAlias, aggregateName, mapKey, columnId, aggregateId]).draw(false);
     }
     }
     +]*/

    // Manually add synchronization between VM input value and projectionTable rows.
    $("input.va-input").on("input", function() {
        projectionTable.rows().every(function (rowIdx, tableLoop, rowLoop) {
            if (this.data()[2]) {
                var numOfVMs = this.data()[2].length;
                var temp = [];
                for (var i = 0; i < numOfVMs; i ++) {
                    temp.push([$("#val-"+rowIdx+"-"+i).val(), $("#ali-"+rowIdx+"-"+i).val()]);
                }
                this.data()[2] = temp;
            }


        });
        UpdatePipelineAndLimitActions();
    });
    // Setup dummy filter builder
    var filterColumns = [
        {
            id: '1',
            label: 'col_1',
            type: 'string'
        },
        {
            id: '2',
            label: 'col_2',
            show_subfield: true,
            type: 'string'
        }
    ];
    // Get columns from database
    /*[+
      // Loop over all fields and build the filter columns
      filterColumns = [];
      var fields = [[${fields}]];
      localStorage.setItem("field_map", JSON.stringify({}));
      for (i = 0; i < fields.length; i++) {
         // Create a new field
         var newField = {};
         // field id is not unique because of flattening of subfields, using name id instead
         newField.id = fields[i].fieldNameId;
         newField.label = fields[i].fieldNameId;
         // show subfield input if it is a generic one
         if (fields[i].key && fields[i].key === '*') {
             newField.show_subfield = true;
         }
         // Check if field is map type
         if (fields[i].notSimpleType == true && fields[i].key == null) {
            newField.type = 'string';
            newField.operators = ['is_null', 'is_not_null'];
            newField.placeholder = 'value';
         } else {
            // Special actions for different types
            switch(fields[i].fieldType) {
              case "string":
                newField.type = 'string';
                newField.operators = ['equal', 'not_equal', 'is_null', 'is_not_null', 'rlike', 'like'];
                newField.placeholder = 'value';
                newField.validation = {
                           format: /^.([^"'])*$/
                        };
                break;
              case "integer":
                newField.type = 'integer';
                newField.operators = ['equal', 'not_equal', 'less', 'less_or_equal', 'greater', 'greater_or_equal'];
                break;
              case "float":
                newField.type = 'double';
                newField.operators = ['equal', 'not_equal', 'less', 'less_or_equal', 'greater', 'greater_or_equal'];
                newField.validation = {
                           step: 'any'
                        };
                break;
              case "boolean":
                newField.type = 'boolean';
                newField.operators = ['equal', 'not_equal', 'is_null', 'is_not_null'];
                newField.input = 'radio';
                newField.values = {1: 'True', 0: 'False'};
                break;
              default:
                console.log("Bad type for fieldNameId: " + fields[i].fieldNameId + " with type: " + fields[i].fieldType);
            }
         }
         // Add new field to filter columns
         filterColumns.push(newField);
         var fieldCompositeKey = newField.id;
         if (fields[i].key) {
            fieldCompositeKey.concat("_").concat(fields[i].key);
         }
         var field_map = JSON.parse(localStorage.getItem("field_map"));
         field_map[fieldCompositeKey] = newField;
         localStorage.setItem("field_map", JSON.stringify(field_map));
      }
      console.log(fields);
    +]*/
    function constructDefaultRules() {

        /*[+
        // Read in default filter rules, without the "condition" field, which is by default "AND"
        var defaultFilterRules = [[${default_filters}]];
        if (!defaultFilterRules) {
            return null;
        }
        +]*/

        // Default rules, to help user
        var defaultRules = {
            condition: 'AND',
            rules: defaultFilterRules
        };

        for (var i = 0; i < defaultRules.rules.length; i++) {
            var currRule = defaultRules.rules[i];
            var field_map = JSON.parse(localStorage.getItem("field_map"));
            if (!field_map[currRule.id]) {
                return null;
            }
        }
        return defaultRules;
    }
    function getDefaultSettings() {
        var defaultSettings = {
            allow_empty: true,
            allow_groups: true,
            conditions: ['AND', 'OR'],
            filters: filterColumns,
            operators: [
                'equal', 'not_equal', 'in', 'not_in', 'less', 'less_or_equal', 'is_empty',
                'is_not_empty', 'greater', 'greater_or_equal', 'is_null', 'is_not_null',
                { type: 'rlike', nb_inputs: 1, multiple: false, apply_to: ['string'] },
		{ type: 'like', nb_inputs: 1, multiple: false, apply_to: ['string'] }
            ],
            lang: {
                add_rule: 'Rule',
                add_group: 'Group',
                delete_rule: '',
                delete_group: '',
                operators: {
                    rlike: 'regex matches'
                }
            },
            plugins: {
                'subfield': null
            }
        };
        var rules = constructDefaultRules();
        if (rules) {
            defaultSettings.rules = rules;
        }
        return defaultSettings;
    }
    $('#filterBuilder').queryBuilder(getDefaultSettings());
    $('#filterBuilder').on('validationError.queryBuilder', function(e, node, error, value) {
        // node is a Rule or a Group
        if (node.filter && node.filter.type == 'string' && error) {
            if (error[0] == 'string_invalid_format') {
                showErrorMessage("No quotes allowed in field " + node.filter.label);
            } else if (error[0] == 'string_empty') {
                showErrorMessage("Input cannot be empty in field " + node.filter.label);
            }
        }
    });
    // If in view mode, set UI widgets
    /*[+
      var filters = JSON.parse([[${filters}]]);
      if (filters != null) {
        // Set filters
        $('#filterBuilder').queryBuilder('setRules', filters);
      }
    +]*/
    // If in view mode, show oozie job / backfill job id if the pipeline has one
    /*[+
      function oozieJobStatusDisplayFun(htmlComponent, jobStatus) {
          if (jobStatus == null) {
              htmlComponent.toggleClass('status na-status');
          }
          else if (jobStatus.includes('ERROR')) {
              htmlComponent.toggleClass('status alert-status');
          }
          else if (jobStatus.includes('FAIL')) {
              htmlComponent.toggleClass('status fail-status');
          }
          else {
              htmlComponent.toggleClass('status ok-status');
          }
      }
      var oozieJobLink = [[${oozieJobLink}]];
      if (oozieJobLink) {
        $("#oozieJobLinkStatusGroup").show();
        var oozieJobStatus = [[${oozieJobStatus}]];
        oozieJobStatusDisplayFun($("#oozieJobStatusDisplay"), oozieJobStatus);
      }
      var oozieBackfillJobLink = [[${oozieBackfillJobLink}]];
      if (oozieBackfillJobLink) {
        $("#oozieBackfillJobLinkStatusGroup").show();
        var oozieBackfillJobStatus = [[${oozieBackfillJobStatus}]];
        oozieJobStatusDisplayFun($("#oozieBackfillJobStatusDisplay"), oozieBackfillJobStatus);
      }
    +]*/
    // Show backfill
    /*[+
      var backfillStartDate = [[${backfillStartDate}]];
      if (backfillStartDate) {
          $('#backfillStartDateSelectorText').val(backfillStartDate);
      } else {
        // Default backfill to yesterday
        var yesterday = new Date();
        yesterday.setDate(yesterday.getDate()-1)
        yesterday = yesterday.toISOString().substring(0,10);
        $('#backfillStartDateSelectorTextGroup').datepicker('setDate', yesterday);
        $('#backfillStartDateSelectorTextGroup').datepicker('update');
        $('#backfillStartDateSelectorTextGroup').val('');
      }
    +]*/
    // If in view mode, show endTime support information
    /*[+
      var endTimeEnabled = [[${endTimeEnabled}]];
    +]*/
    // If in view mode, show UI links
    /*[+
        if ([[${viewPipeline}]] != null && [[${oozieJobLink}]] != null) {
            $("#uiLinkStatusGroup").show();
        }
    +]*/
    /*]]>*/
    // On edit of filters, require update and disable launch.
    $('#filterBuilder').on('afterUpdateRuleValue.queryBuilder ' +
        'afterUpdateRuleOperator.queryBuilder ' +
        'afterUpdateRuleFilter.queryBuilder ' +
        'afterUpdateGroupCondition.queryBuilder ' +
        'afterDeleteGroup.queryBuilder ' +
        'afterDeleteRule.queryBuilder' , function(e, rule, error, value) {
        UpdatePipelineAndLimitActions();
    });


    // Prevent Immediate Propagation of the click event
    $("input.va-input").click(function(e) {
        e.stopImmediatePropagation();
    });

    // On change of value mapping, require update and disable launch.
    $("ul.va-list").change(function() {
        UpdatePipelineAndLimitActions();
    });


    var lastSel = $("#schemaSelector option:selected");

    $("#schemaSelector").click(function() {
        lastSel = $("#schemaSelector option:selected");
    });

    $("#schemaSelector").change(function() {
        var r = confirm("Do you want to change the schema? You will lose the information you typed in this web page.");
        if (r == true) {
            window.location.href = '/datamart/new?schemaName=' + this.value;
        } else {
            lastSel.prop("selected", true);
        }
    });

</script>


</body>
</html>
